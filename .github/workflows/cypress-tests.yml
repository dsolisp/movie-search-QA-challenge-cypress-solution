name: Cypress Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install backend dependencies
      working-directory: ./backend
      run: npm install
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm install
    
    - name: Install Cypress dependencies
      working-directory: ./cypress-e2e
      run: npm install
    
    - name: Start backend service
      working-directory: ./backend
      env:
        OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      run: |
        npm start > ../backend.log 2>&1 &
        BACKEND_PID=$!
        echo "Backend PID: $BACKEND_PID"
        sleep 4
        if ! kill -0 $BACKEND_PID 2>/dev/null; then
          echo "Backend failed to start!"
          cat ../backend.log
          exit 1
        fi
    
    - name: Start frontend service
      working-directory: ./frontend
      run: |
        npm run build > ../frontend-build.log 2>&1
        npm run dev > ../frontend.log 2>&1 &
        FRONTEND_PID=$!
        echo "Frontend PID: $FRONTEND_PID"
        sleep 6
        if ! kill -0 $FRONTEND_PID 2>/dev/null; then
          echo "Frontend failed to start!"
          cat ../frontend.log
          exit 1
        fi
    
    - name: Verify services are running
      run: |
        echo "Checking backend..."
        for i in {1..15}; do
          if curl -s http://localhost:3000 > /dev/null 2>&1; then
            echo "✓ Backend is ready"
            break
          fi
          if [ $i -eq 15 ]; then
            echo "✗ Backend failed to respond"
            cat backend.log || true
            exit 1
          fi
          echo "Waiting for backend... ($i/15)"
          sleep 1
        done
        
        echo "Checking frontend..."
        for i in {1..15}; do
          if curl -s http://localhost:3001 > /dev/null 2>&1; then
            echo "✓ Frontend is ready"
            break
          fi
          if [ $i -eq 15 ]; then
            echo "✗ Frontend failed to respond"
            cat frontend.log || true
            exit 1
          fi
          echo "Waiting for frontend... ($i/15)"
          sleep 1
        done
    
    - name: Run API tests
      working-directory: ./cypress-e2e
      run: npm run cypress:run -- --spec "cypress/e2e/api_endpoints.cy.ts"
      continue-on-error: true
    
    - name: Run UI tests
      working-directory: ./cypress-e2e
      run: npm run cypress:run -- --spec "cypress/e2e/ui_flows.cy.ts"
      continue-on-error: true
    
    - name: Run component tests
      working-directory: ./cypress-e2e
      run: npm run cypress:run:component
      continue-on-error: true
    
    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-reports
        path: cypress-e2e/cypress/reports/
        retention-days: 30
    
    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-screenshots
        path: cypress-e2e/cypress/screenshots/
        retention-days: 7
    
    - name: Upload videos
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-videos
        path: cypress-e2e/cypress/videos/
        retention-days: 7
    
    - name: Check service logs on failure
      if: failure()
      run: |
        echo "=== Backend Log ===" && cat backend.log 2>/dev/null || echo "No backend.log"
        echo "=== Frontend Build Log ===" && cat frontend-build.log 2>/dev/null || echo "No frontend-build.log"
        echo "=== Frontend Log ===" && cat frontend.log 2>/dev/null || echo "No frontend.log"
